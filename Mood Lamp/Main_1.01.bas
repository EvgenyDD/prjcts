$regfile = "m16def.dat"
$crystal = 26000000

Ddra = &B11111000
Ddrb = &B11111111
Ddrc = &B11111111
Ddrd = &B11110000
Porta = &B00000000
Portb = &B11111111
Portc = &B00000000
Portd = &B00000100
'===============================================================================
Dim X As Byte
Dim Y As Byte
Dim Z As Byte

Dim W As Word

Dim H As Byte
Dim F As Byte
Dim Aa As Byte

Dim Modes As Byte
Dim Rgb(15) As Byte
Dim Tik As Byte

R Alias Portd.7
G Alias Portd.6
Btn Alias Pind.2

'Vr Alias Pina.2      'Getadc(2)----переменник
'Zvuk Alias Pina.1    'Getadc(1)----микрофон
'Svet Alias Pina.0    'Getadc(0)----фотодиод
'========================Init===================================================
Config Adc = Single , Prescaler = Auto , Reference = Avcc
Config Int0 = Falling
Config Timer0 = Timer , Prescale = 8                        'настраиваем таймер
Enable Timer0                                               'разрешаем работу таймера 0
Enable Int0
Enable Interrupts                                           'Разрешаем прерывания
On Timer0 Pwm_out                                           'работа по таймеру 0
Start Timer0                                                'старт таймера 0
On Int0 Int_0
'===============================================================================
For X = 1 To 5
  Rgb(x) = 255
Next X
'===========================main cycle==========================================
Do
Portb = Lookup(modes , 7seg)
On Modes Gosub M0 , M1 , M2 , M3 , M4 , M5 , M6 , M7 , M8 , M9 , M10

Loop
'===============================================================================
'===============================================================================
'===============================================================================
'===============================================================================
'===============================================================================
'===============================================================================
'===============================================================================
'===============================================================================
'===============================================================================
M0:

W = Getadc(2)
W = W / 24
Y = W

For X = 1 To 5
  Z = Lookup(y , R_data)
  Rgb(x) = Lookup(z , Bright )
Next X

For X = 6 To 10
  Z = Lookup(y , G_data)
  Rgb(x) = Lookup(z , Bright )
Next X

For X = 11 To 15
  Z = Lookup(y , B_data)
  Rgb(x) = Lookup(z , Bright )
Next X
Return
'===============================================================================
M1:
Return
'===============================================================================
M2:
Return
'===============================================================================
M3:
Return
'===============================================================================
M4:
Return
'===============================================================================
'последовательный перебор цветовой линейки туда-сюда
M5:
For X = 0 To 41
  Y = Lookup(x , R_data)
  Z = Lookup(x , G_data)
  H = Lookup(x , B_data)
  Waitms 200
  For F = 0 To 5 : Aa = Lookup(y , Bright) : Rgb(f) = Aa : Next X
  For F = 6 To 10 : Aa = Lookup(z , Bright) : Rgb(f) = Aa : Next X
  For F = 11 To 15 : Aa = Lookup(h , Bright) : Rgb(f) = Aa : Next X
Next F

For X = 41 To 0 Step -1
  Y = Lookup(x , R_data)
  Z = Lookup(x , G_data)
  H = Lookup(x , B_data)
  Waitms 200
  For F = 0 To 5 : Aa = Lookup(y , Bright) : Rgb(f) = Aa : Next X
  For F = 6 To 10 : Aa = Lookup(z , Bright) : Rgb(f) = Aa : Next X
  For F = 11 To 15 : Aa = Lookup(h , Bright) : Rgb(f) = Aa : Next X
Next X
Return
'===============================================================================
M6:
Return
'===============================================================================
M7:
Return
'===============================================================================
M8:
Return
'===============================================================================
M9:
Return
'===============================================================================
M10:
Return
'===============================================================================
'===============================================================================
'===============================================================================
'===============================================================================
'===============================================================================
'===============================================================================
'===============================================================================
'===============================================================================
'===============================================================================

Pwm_out:
Incr Tik
 If Tik = 255 Then
  Tik = 0
  Portc = 0
  Porta = 0
  Portd = &B00000100
 End If
   If Tik > Rgb(1) Then Porta.6 = 1                         'R
   If Tik > Rgb(2) Then Porta.7 = 1
   If Tik > Rgb(3) Then Porta.5 = 1
   If Tik > Rgb(4) Then Porta.4 = 1
   If Tik > Rgb(5) Then Portc.7 = 1
   If Tik > Rgb(6) Then Portd.4 = 1                         'G
   If Tik > Rgb(7) Then Portc.3 = 1
   If Tik > Rgb(8) Then Portc.6 = 1
   If Tik > Rgb(9) Then Porta.3 = 1
  If Tik > Rgb(10) Then Portc.0 = 1
  If Tik > Rgb(11) Then Portc.4 = 1                         'B
  If Tik > Rgb(12) Then Portc.5 = 1
  If Tik > Rgb(13) Then Portd.5 = 1
  If Tik > Rgb(14) Then Portc.1 = 1
  If Tik > Rgb(15) Then Portc.2 = 1
Return
'+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
Int_0:
Incr Modes
If Modes = 11 Then : Modes = 0 : End If
Gifr = 64
Return
'+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

7seg:
Data &B00100001 , &B11110101 , &B00010011 , &B10010001 , &B11000101 , &B10001001 , &B00001001 , &B11110001 , &B00000001 , &B10000001 , &B01000001 , &B00001101 , &B00001011       'B

Bright:
Data 255 , 249 , 243 , 231 , 208 , 162 , 73 , 0
'Data 255 , 253 , 252 , 251 , 249 , 246 , 243 , 238 , 231 , 221 , 208 , 189 , 162 , 125 , 73 , 0

R_data:
Data 7 , 7 , 7 , 7 , 7 , 7 , 7 , 7 , 6 , 5 , 4 , 3 , 2 , 1 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 1 , 2 , 3 , 4 , 5 , 6 , 7 , 7 , 7 , 7 , 7 , 7 , 7
G_data:
Data 0 , 1 , 2 , 3 , 4 , 5 , 6 , 7 , 7 , 7 , 7 , 7 , 7 , 7 , 7 , 7 , 7 , 7 , 7 , 7 , 7 , 7 , 6 , 5 , 4 , 3 , 2 , 1 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0
B_data:
Data 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 0 , 1 , 2 , 3 , 4 , 5 , 6 , 7 , 7 , 7 , 7 , 7 , 7 , 7 , 7 , 7 , 7 , 7 , 7 , 7 , 7 , 7 , 6 , 5 , 4 , 3 , 2 , 1
'----R-0-------------------------rg-7------------------------G-14------------------------gb-21-----------------------B-28------------------------rb-35-------------------41
     э0 1 2 3 5 8 11 15 20 27 40 55 80 110 145 190 255
'1r -a6
'1g d4
'1b c4
'2r a7
'2g c3
'2b c5
'3r a5
'3g c6
'3b d5
'4r a4
'4g a3
'4b c1
'5r c7
'5g c0
'5b c2